# CNBlogs Sync - 版本历史和更新日志

## 版本信息

- **当前版本**：v1.2.0
- **发布日期**：2026-02-01
- **许可证**：GPLv2+
- **WordPress 要求**：5.0+
- **PHP 要求**：7.4+

---

## v1.2.0 (2026-02-01)

### ♻️ 重构与改进

- **菜单位置调整**：将插件入口从顶级菜单移动至 `设置 > CNBlogs 同步`，保持后台整洁。
- **界面优化**：后台设置页面重构为标签页（Tabs）布局，分为设置、状态、日志、关于四个版块。
- **关于页面**：新增"关于"标签页，提供 GitHub 项目地址、Issue 反馈链接及功能简介。

### ✨ 新增功能

- **卸载选项**：设置页面新增"卸载时删除数据"选项（默认保留），允许用户完全清理插件残留。

### 🛡️ 安全与合规

- **许可证更新**：项目许可证更新为 GPLv2+，完全符合 WordPress 官方插件目录标准。
- **SQL 兼容性**：修复了 `cnblogs-sync.php` 中的 SQL Prepare 语句兼容性问题，确保在不同 WP 版本下的稳定性。
- **卸载逻辑**：迁移卸载逻辑至标准的 `uninstall.php`，采用更规范的清理流程。

---

## v1.1.1 (2026-02-01)

### ✨ 改进

- 当 CNBlogs 远程不存在文章分类时，先自动创建分类再同步文章。
- 简化后台表单中的 MetaWeblog 访问令牌描述文案。

---

## v1.1.0 (2026-02-01)

### ✨ 新增功能

#### 同步选项增强
- ✅ 新增 "同步标签、分类与摘要" 设置选项（默认开启）。
- 当遇到 API 兼容性问题或不需要同步这些元数据时，可以关闭此选项以提高同步成功率。

### 🐛 Bug 修复

#### 古腾堡编辑器 UI 修复
- 修复了在古腾堡（Block Editor）编辑器下，点击同步按钮后状态不刷新的问题。
- 将 JS 选择器从 Class 更新为 ID，并增加了 `MutationObserver` 以支持动态加载的 DOM。

### 📋 文档与协议

- **文档重构**：所有文档归档至 `docs/` 目录。
- **协议变更**：项目许可协议变更为 **CC BY-NC-SA 4.0**（署名-非商业性使用-相同方式共享），明确禁止商业使用。

---

## v1.0.4 (2026-01-31)

### 🐛 Bug 修复 - 关键

#### 动态 Blog ID 支持 (Hotfix)
- **问题**：在 `metaWeblog.newPost` 等方法中使用硬编码的 Blog ID ('1') 导致部分用户无法发布文章。
- **修复**：
  - 移除了硬编码的 ID '1'。
  - 在“测试连接”时自动获取并保存用户的真实 Blog ID。
  - 所有需要 Blog ID 的 API 调用现在都使用动态获取的 ID。
- **文件修改**：
  - `includes/class-cnblogs-sync.php`: 增加 ID 保存和读取逻辑。
  - `includes/metaweblog-client.php`: 支持传入 Blog ID 并在 API 调用中使用。

#### MetaWeblog.editPost 参数顺序修复
- **问题**：编辑文章时 API 返回 HTTP 500 错误
- **错误信息**：`Object reference not set to an instance of an object.`
- **根本原因**：`metaWeblog.editPost()` 方法的参数顺序不正确
- **详细说明**：
  - 修复为标准的 `editPost(postid, username, password, struct, publish)` 顺序。
- **详细说明**：
  - CNBlogs API 要求 blogid 作为第一个参数
  - 修复前：`editPost(postid, username, password, struct, publish)`
  - 修复后：`editPost(blogid, postid, username, password, struct, publish)`
- **文件修改**：`includes/metaweblog-client.php`
- **影响范围**：所有进行文章编辑/更新操作的用户

#### 调试日志增强
- 添加详细的编辑操作日志
- 记录发送的数据结构（标题、内容长度、分类、标签）
- 记录 API 调用参数信息
- 记录编辑操作的成功/失败状态

### 📋 文档新增

- ✅ `docs/API-PARAMETER-FIX.md` - API 参数修复的详细技术说明
- ✅ `docs/V1.0.4-API-FIX-SUMMARY.md` - 修复摘要和升级指南
- ✅ `verify-api-fix.sh` - Linux/Mac 验证脚本
- ✅ `verify-api-fix.ps1` - Windows PowerShell 验证脚本

### ✨ 改进

- 优化调试日志输出格式
- 提供自动验证脚本便于快速检验修复

---

## v1.0.3 (2026-01-31)

### 🎉 新增功能

#### 文章管理页面增强
- ✅ 在文章列表页面添加"同步到 CNBlogs"快速操作按钮
- ✅ 在文章列表中显示同步状态列（✓已同步、✗失败、⏳待处理）
- ✅ 在文章编辑页面添加同步状态 Meta Box
- ✅ 在文章编辑页面添加"立即同步"按钮

#### 数据库记录功能
- ✅ 创建 `wp_cnblogs_sync_records` 表用于记录同步历史
- ✅ 记录同步状态、时间、错误信息、CNBlogs 链接等
- ✅ 支持查询和追踪文章同步历史

### 🐛 Bug 修复

#### 脚本加载问题
- 修复：JavaScript 文件未在文章列表页面加载
- **原因**：脚本加载条件不包含 `edit.php`
- **解决**：添加 `edit.php` 到脚本加载条件列表
- **影响**：文章列表页面的同步按钮现在可以正常工作

#### 重复方法定义错误
- 修复：PHP Fatal error - `add_sync_meta_box()` 方法被声明两次
- **原因**：第 510 行和第 894 行各定义了一次
- **解决**：删除了旧版本的方法定义（第 510-575 行）
- **保留**：更完整、功能更全的新版本方法

#### 前端脚本语法错误
- 修复：`admin.js` 中 `quickSyncPost()` 方法有重复的结束代码块
- **原因**：代码编辑过程中产生的重复行
- **解决**：删除了多余的 `}` 和 `});`

### 📊 改进

#### 调试和诊断
- 添加详细的 console.log 日志用于调试
- 脚本加载、事件触发、AJAX 请求都有日志输出
- 错误消息更加详细和可操作

#### 错误处理
- 改进 nonce 验证
- 添加权限检查
- 完善异常处理和错误提示

#### 用户体验
- 按钮状态反馈更清晰
- 同步状态显示更直观
- 加入成功/失败的视觉反馈

### 📝 文档和工具

- ✅ 新增 `BUGFIX-SYNC-BUTTON.md` - 同步按钮修复说明
- ✅ 完整的错误处理文档
- ✅ 调试日志查看指南

---

## v1.0.2 (2026-01-31)

### 🔍 诊断和错误处理改进

#### MetaWeblog API 处理优化
- ✅ 改进 `blogger.getUsersBlogs` 方法的验证
- ✅ 验证返回的 BlogInfo 结构完整性
- ✅ 区分"空数组"和"解析失败"情况
- ✅ 输出完整的博客详情用于诊断

#### 错误处理逻辑改进
**之前**：空博客列表 → ❌ 错误

**现在**：
- HTTP 错误（401/404）→ ✗ 错误（带解决建议）
- 空博客列表 + HTTP 200 → ⚠️ 警告（带诊断建议）
- 有博客列表 + HTTP 200 → ✓ 成功

#### 详细的诊断日志
- `request()` 方法：记录每个 XML-RPC 请求
- API 响应：HTTP 状态码、响应体大小
- 响应解析：返回类型、元素数量
- BlogInfo 验证：字段完整性检查

### 📚 新增文档

- ✅ `QUICK-DIAGNOSIS.md` - 快速诊断指南（关键文档！）
- ✅ `EMPTY-BLOG-LIST-FIX.md` - 空博客列表问题说明
- ✅ `SOLUTION-SUMMARY.md` - 解决方案总结
- ✅ `QUICK-REFERENCE.md` - 快速参考卡片
- ✅ `UPGRADE-GUIDE.md` - 升级指南
- ✅ `FILE-MANIFEST.md` - 文件清单

### 🛠️ 新增工具

- ✅ `includes/cli-test-connection.php` - WordPress CLI 诊断工具
  ```bash
  wp eval-file path/to/cnblogs-sync/includes/cli-test-connection.php
  ```

### 🔧 技术改进

- 改进 `parse_xml_rpc_response()` 方法，对数组类型更宽松
- 完善 `get_users_blogs()` 验证和日志记录
- 改进测试连接的错误处理
- 更详细的 AJAX 错误提示

---

## v1.0.1 (2026-01-31)

### ✨ UI 和基础功能修复

#### 后台界面改进
- ✅ 修复后台 CSS Grid 两列布局
- ✅ 改进设置页面的响应式设计
- ✅ 优化表单元素样式

#### 功能修复
- ✅ 修复测试连接按钮无响应问题
- ✅ 修复 JSON 解析错误（通过输出缓冲）
- ✅ 修复 API URL 预填问题
- ✅ 修复密码标签显示问题

#### 代码优化
- ✅ 删除冗余的设置页面描述
- ✅ 简化设置表单
- ✅ 改进代码结构

### 🔧 PHP 和 JavaScript 修复

#### PHP 语法错误修复
- 修复嵌套 try-catch 结构错误
- 删除空 catch 块
- 纠正括号配对错误

#### JavaScript 语法错误修复
- 完全重建 `admin.js` 文件
- 修复编码问题
- 简化实现同时保留所有功能

#### 版本更新
- 版本号：1.0.0 → 1.0.1
- 更新 package.json
- 更新插件头信息

### 📋 初始化文档和功能

- ✅ MetaWeblog API 全面实现
- ✅ 所有 9 个 CNBlogs 支持的方法已实现
- ✅ 移除不支持的 `blogger.getUserInfo` 方法
- ✅ 完善错误处理和日志记录

---

## v1.0.0 (初始版本)

### 核心功能

- ✅ WordPress 后台设置页面
- ✅ MetaWeblog API 连接测试
- ✅ 基础文章同步功能
- ✅ CNBlogs 集成

---

## 功能对比表

| 功能 | v1.0.0 | v1.0.1 | v1.0.2 | v1.0.3 |
|------|--------|--------|--------|--------|
| 基础同步 | ✅ | ✅ | ✅ | ✅ |
| MetaWeblog API | ✅ | ✅ | ✅ | ✅ |
| 测试连接 | ⚠️ | ✅ | ✅ | ✅ |
| 诊断日志 | ❌ | ⚠️ | ✅ | ✅ |
| 文章列表快速同步 | ❌ | ❌ | ❌ | ✅ |
| 同步状态列 | ❌ | ❌ | ❌ | ✅ |
| Meta Box 状态显示 | ⚠️ | ⚠️ | ⚠️ | ✅ |
| 同步历史记录 | ❌ | ❌ | ❌ | ✅ |
| CLI 诊断工具 | ❌ | ❌ | ✅ | ✅ |
| 快速诊断指南 | ❌ | ❌ | ✅ | ✅ |

---

## 已知问题和解决方案

### 问题 1：测试连接返回"博客列表为空"

**原因**：可能是 MetaWeblog 令牌过期或不正确

**解决**：
1. 查看 `QUICK-DIAGNOSIS.md` 中的快速诊断步骤
2. 重新获取 MetaWeblog 令牌
3. 确认 CNBlogs 账户有博客
4. 查看 WordPress 调试日志

**版本修复**：v1.0.2 开始提供详细诊断日志

### 问题 2：文章列表同步按钮无响应

**原因**：v1.0.3 之前脚本未在文章列表页面加载

**解决**：升级到 v1.0.3

**细节**：见 `BUGFIX-SYNC-BUTTON.md`

---

## 升级路径

### 从 v1.0.0 升级到 v1.0.1
- ✅ 完全向后兼容
- 只需覆盖文件即可
- 无需迁移数据

### 从 v1.0.1 升级到 v1.0.2
- ✅ 完全向后兼容
- 新增诊断功能
- 改进错误处理
- 无需迁移数据

### 从 v1.0.2 升级到 v1.0.3
- ✅ 完全向后兼容
- 新增数据库表 `wp_cnblogs_sync_records`
- 自动创建，无需手动操作
- 修复脚本加载问题

---

## 技术指标

| 指标 | 1.0.0 | 1.0.1 | 1.0.2 | 1.0.3 |
|------|-------|-------|-------|-------|
| PHP 文件 | 3 | 3 | 4 | 4 |
| JS 文件 | 1 | 1 | 1 | 1 |
| CSS 文件 | 0 | 1 | 1 | 1 |
| 文档文件 | 1 | 2 | 8 | 3* |
| 代码行数 | ~800 | ~900 | ~950 | ~1000 |
| 诊断功能 | ❌ | ⚠️ | ✅ | ✅ |

*经过整理合并

---

## 依赖项

- WordPress：5.0 或更高版本
- PHP：7.4 或更高版本
- MySQL：5.7 或更高版本
- 扩展：cURL、libxml

---

## 相关文档

- 使用指南：[USER-GUIDE.md](USER-GUIDE.md)
- 快速诊断：[QUICK-DIAGNOSIS.md](QUICK-DIAGNOSIS.md)
- 安装说明：[INSTALLATION.md](INSTALLATION.md)
- 快速开始：[README-QUICK.md](README-QUICK.md)

